---
import DefaultHead from '@astrojs/starlight/components/Head.astro';
---

<DefaultHead />
<slot />

<script>
	let mermaidPromise;
	const getMermaid = async () => {
		if (!mermaidPromise) {
			mermaidPromise = import('mermaid').then((mod) => mod.default ?? mod);
		}
		return mermaidPromise;
	};

	const getMermaidTheme = () => (document.documentElement.dataset.theme === 'dark' ? 'dark' : 'default');

	let initializedTheme = null;
	let renderScheduled = false;

	function extractMermaidSourceFromPre(pre) {
		const figure = pre.closest('figure');
		const copyButton = figure?.querySelector('button[data-code]');
		const dataCode = copyButton?.getAttribute('data-code');
		if (dataCode) return dataCode.split('\u007f').join('\n').trim();

		const lines = Array.from(pre.querySelectorAll('.ec-line .code')).map((line) => line.textContent ?? '');
		const joined = lines.join('\n').trim();
		if (joined) return joined;

		return (pre.textContent ?? '').trim();
	}

	function normalizeMermaidBlocks() {
		const preBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

		for (const pre of preBlocks) {
			const source = extractMermaidSourceFromPre(pre);
			if (!source) continue;

			const container = document.createElement('div');
			container.className = 'mermaid';
			container.dataset.mermaidSource = source;
			container.textContent = source;

			(pre.closest('figure') ?? pre).replaceWith(container);
		}
	}

	async function renderMermaid() {
		normalizeMermaidBlocks();

		const nodes = Array.from(document.querySelectorAll('.mermaid'));
		if (nodes.length === 0) return;

		const mermaid = await getMermaid();

		const theme = getMermaidTheme();
		if (theme !== initializedTheme) {
			mermaid.initialize({
				startOnLoad: false,
				theme,
				securityLevel: 'strict',
			});
			initializedTheme = theme;
		}

		for (const node of nodes) {
			const source = node.dataset.mermaidSource;
			if (!source) continue;
			node.textContent = source;
			node.removeAttribute('data-processed');
		}

		await mermaid.run({ nodes });
	}

	function scheduleRender() {
		if (renderScheduled) return;
		renderScheduled = true;
		requestAnimationFrame(() => {
			renderScheduled = false;
			renderMermaid().catch((err) => console.warn('[mermaid] render failed', err));
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', scheduleRender, { once: true });
	} else {
		scheduleRender();
	}

	document.addEventListener('astro:page-load', scheduleRender);
	document.addEventListener('astro:after-swap', scheduleRender);

	new MutationObserver(scheduleRender).observe(document.documentElement, {
		attributes: true,
		attributeFilter: ['data-theme'],
	});
</script>
