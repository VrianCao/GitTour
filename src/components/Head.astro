---
import DefaultHead from '@astrojs/starlight/components/Head.astro';
---

<DefaultHead />
<slot />

<script>
	let mermaidPromise;
	const getMermaid = async () => {
		if (!mermaidPromise) {
			mermaidPromise = import('mermaid').then((mod) => mod.default ?? mod);
		}
		return mermaidPromise;
	};

	const isDarkMode = () => document.documentElement.dataset.theme === 'dark';

	let initializedMode = null;
	let renderScheduled = false;

	const css = () => getComputedStyle(document.documentElement);
	const colorProbe = document.createElement('span');
	colorProbe.style.position = 'absolute';
	colorProbe.style.width = '0';
	colorProbe.style.height = '0';
	colorProbe.style.overflow = 'hidden';
	document.body.appendChild(colorProbe);

	const rgbToHex = (rgb) => {
		const match = rgb.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
		if (!match) return null;
		const toHex = (n) => Number(n).toString(16).padStart(2, '0');
		return `#${toHex(match[1])}${toHex(match[2])}${toHex(match[3])}`;
	};

	const toHexColor = (value, fallback) => {
		const raw = (value || fallback || '').trim();
		if (!raw) return '#000000';
		if (raw.startsWith('#')) return raw;
		colorProbe.style.color = raw;
		return rgbToHex(getComputedStyle(colorProbe).color) || '#000000';
	};

	const getVar = (name, fallback) => toHexColor(css().getPropertyValue(name), fallback);

	const getMermaidThemeVariables = (darkMode) => {
		const surface = getVar('--sl-color-bg-inline-code', darkMode ? '#111827' : '#f4f4f4');
		const surfaceAlt = getVar('--sl-color-bg-nav', darkMode ? '#0b1220' : '#ffffff');
		const text = getVar('--sl-color-text', darkMode ? '#e5e7eb' : '#111827');
		const textStrong = getVar('--sl-color-gray-1', darkMode ? '#f3f4f6' : '#0f172a');
		const line = getVar('--sl-color-gray-3', darkMode ? '#9ca3af' : '#4b5563');
		const border = getVar('--sl-color-hairline-light', darkMode ? '#334155' : '#cbd5e1');
		const accent = getVar('--sl-color-accent', '#f05033');
		const accentLow = getVar('--sl-color-accent-low', darkMode ? '#2a0d08' : '#ffe6e1');

		return {
			darkMode,
			// Only hex colors are supported by Mermaid's theming engine.
			background: surface,
			fontFamily: 'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif',
			primaryColor: surfaceAlt,
			primaryTextColor: textStrong,
			primaryBorderColor: border,
			secondaryColor: surface,
			secondaryTextColor: textStrong,
			secondaryBorderColor: border,
			tertiaryColor: accentLow,
			tertiaryTextColor: textStrong,
			tertiaryBorderColor: accent,
			textColor: text,
			lineColor: line,
			edgeLabelBackground: surface,
			clusterBkg: surface,
			clusterBorder: border,
			titleColor: textStrong,
			noteBkgColor: surface,
			noteTextColor: textStrong,
			noteBorderColor: border,
		};
	};

	function extractMermaidSourceFromPre(pre) {
		const figure = pre.closest('figure');
		const copyButton = figure?.querySelector('button[data-code]');
		const dataCode = copyButton?.getAttribute('data-code');
		if (dataCode) return dataCode.split('\u007f').join('\n').trim();

		const lines = Array.from(pre.querySelectorAll('.ec-line .code')).map((line) => line.textContent ?? '');
		const joined = lines.join('\n').trim();
		if (joined) return joined;

		return (pre.textContent ?? '').trim();
	}

	function normalizeMermaidBlocks() {
		const preBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

		for (const pre of preBlocks) {
			const source = extractMermaidSourceFromPre(pre);
			if (!source) continue;

			const container = document.createElement('div');
			container.className = 'mermaid';
			container.dataset.mermaidSource = source;
			container.textContent = source;

			(pre.closest('figure') ?? pre).replaceWith(container);
		}
	}

	async function renderMermaid() {
		normalizeMermaidBlocks();

		const nodes = Array.from(document.querySelectorAll('.mermaid'));
		if (nodes.length === 0) return;

		const mermaid = await getMermaid();

		const darkMode = isDarkMode();
		if (darkMode !== initializedMode) {
			mermaid.initialize({
				startOnLoad: false,
				theme: 'base',
				themeVariables: getMermaidThemeVariables(darkMode),
				securityLevel: 'strict',
			});
			initializedMode = darkMode;
		}

		for (const node of nodes) {
			const source = node.dataset.mermaidSource;
			if (!source) continue;
			node.textContent = source;
			node.removeAttribute('data-processed');
		}

		await mermaid.run({ nodes });
	}

	function scheduleRender() {
		if (renderScheduled) return;
		renderScheduled = true;
		requestAnimationFrame(() => {
			renderScheduled = false;
			renderMermaid().catch((err) => console.warn('[mermaid] render failed', err));
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', scheduleRender, { once: true });
	} else {
		scheduleRender();
	}

	document.addEventListener('astro:page-load', scheduleRender);
	document.addEventListener('astro:after-swap', scheduleRender);

	new MutationObserver(scheduleRender).observe(document.documentElement, {
		attributes: true,
		attributeFilter: ['data-theme'],
	});
</script>
