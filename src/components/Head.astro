---
import DefaultHead from '@astrojs/starlight/components/Head.astro';
---

<DefaultHead />
<slot />

<script>
	let mermaidPromise;
	const getMermaid = async () => {
		if (!mermaidPromise) {
			mermaidPromise = import('mermaid').then((mod) => mod.default ?? mod);
		}
		return mermaidPromise;
	};

	const isDarkMode = () => document.documentElement.dataset.theme === 'dark';

	let initializedMode = null;
	let renderScheduled = false;

	// Hardcoded palettes for reliable contrast in both themes
	const getMermaidThemeVariables = (darkMode) => {
		// Font stack
		const fontFamily =
			'system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif';

		if (darkMode) {
			// ============ DARK MODE ============
			return {
				darkMode: true,
				fontFamily,
				// Canvas background (matches code block bg)
				background: '#1e293b',
				// Primary nodes (main flow elements)
				primaryColor: '#334155',
				primaryTextColor: '#f1f5f9',
				primaryBorderColor: '#64748b',
				// Secondary nodes (alt branches, conditions)
				secondaryColor: '#1e3a5f',
				secondaryTextColor: '#e2e8f0',
				secondaryBorderColor: '#3b82f6',
				// Tertiary nodes (highlights, decisions)
				tertiaryColor: '#3f1f1a',
				tertiaryTextColor: '#fecaca',
				tertiaryBorderColor: '#f05033',
				// Generic text & lines
				textColor: '#e2e8f0',
				lineColor: '#94a3b8',
				// Edge labels
				edgeLabelBackground: '#1e293b',
				// Subgraph clusters
				clusterBkg: '#0f172a',
				clusterBorder: '#475569',
				// Title
				titleColor: '#f8fafc',
				// Notes (sequence diagrams)
				noteBkgColor: '#fef3c7',
				noteTextColor: '#78350f',
				noteBorderColor: '#f59e0b',
				// Git graph specifics
				git0: '#22c55e',
				git1: '#3b82f6',
				git2: '#f59e0b',
				git3: '#ec4899',
				git4: '#8b5cf6',
				git5: '#06b6d4',
				git6: '#84cc16',
				git7: '#f43f5e',
				gitBranchLabel0: '#bbf7d0',
				gitBranchLabel1: '#bfdbfe',
				gitBranchLabel2: '#fef08a',
				gitBranchLabel3: '#fbcfe8',
				gitBranchLabel4: '#ddd6fe',
				gitBranchLabel5: '#a5f3fc',
				gitBranchLabel6: '#d9f99d',
				gitBranchLabel7: '#fecdd3',
				commitLabelColor: '#f1f5f9',
				commitLabelBackground: '#334155',
				tagLabelColor: '#fef3c7',
				tagLabelBackground: '#b45309',
				tagLabelBorder: '#f59e0b',
			};
		} else {
			// ============ LIGHT MODE ============
			return {
				darkMode: false,
				fontFamily,
				// Canvas background
				background: '#f8fafc',
				// Primary nodes
				primaryColor: '#e2e8f0',
				primaryTextColor: '#1e293b',
				primaryBorderColor: '#94a3b8',
				// Secondary nodes
				secondaryColor: '#dbeafe',
				secondaryTextColor: '#1e3a8a',
				secondaryBorderColor: '#3b82f6',
				// Tertiary nodes (accent-themed)
				tertiaryColor: '#fee2e2',
				tertiaryTextColor: '#991b1b',
				tertiaryBorderColor: '#dc2626',
				// Generic text & lines
				textColor: '#334155',
				lineColor: '#64748b',
				// Edge labels
				edgeLabelBackground: '#f8fafc',
				// Subgraph clusters
				clusterBkg: '#f1f5f9',
				clusterBorder: '#cbd5e1',
				// Title
				titleColor: '#0f172a',
				// Notes
				noteBkgColor: '#fef9c3',
				noteTextColor: '#713f12',
				noteBorderColor: '#ca8a04',
				// Git graph specifics
				git0: '#16a34a',
				git1: '#2563eb',
				git2: '#d97706',
				git3: '#db2777',
				git4: '#7c3aed',
				git5: '#0891b2',
				git6: '#65a30d',
				git7: '#e11d48',
				gitBranchLabel0: '#14532d',
				gitBranchLabel1: '#1e3a8a',
				gitBranchLabel2: '#78350f',
				gitBranchLabel3: '#831843',
				gitBranchLabel4: '#4c1d95',
				gitBranchLabel5: '#164e63',
				gitBranchLabel6: '#365314',
				gitBranchLabel7: '#881337',
				commitLabelColor: '#334155',
				commitLabelBackground: '#e2e8f0',
				tagLabelColor: '#78350f',
				tagLabelBackground: '#fef3c7',
				tagLabelBorder: '#d97706',
			};
		}
	};

	function extractMermaidSourceFromPre(pre) {
		const figure = pre.closest('figure');
		const copyButton = figure?.querySelector('button[data-code]');
		const dataCode = copyButton?.getAttribute('data-code');
		if (dataCode) return dataCode.split('\u007f').join('\n').trim();

		const lines = Array.from(pre.querySelectorAll('.ec-line .code')).map((line) => line.textContent ?? '');
		const joined = lines.join('\n').trim();
		if (joined) return joined;

		return (pre.textContent ?? '').trim();
	}

	function normalizeMermaidBlocks() {
		const preBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

		for (const pre of preBlocks) {
			const source = extractMermaidSourceFromPre(pre);
			if (!source) continue;

			const container = document.createElement('div');
			container.className = 'mermaid';
			container.dataset.mermaidSource = source;
			container.textContent = source;

			(pre.closest('figure') ?? pre).replaceWith(container);
		}
	}

	async function renderMermaid() {
		normalizeMermaidBlocks();

		const nodes = Array.from(document.querySelectorAll('.mermaid'));
		if (nodes.length === 0) return;

		const mermaid = await getMermaid();

		const darkMode = isDarkMode();
		if (darkMode !== initializedMode) {
			mermaid.initialize({
				startOnLoad: false,
				theme: 'base',
				themeVariables: getMermaidThemeVariables(darkMode),
				securityLevel: 'strict',
			});
			initializedMode = darkMode;
		}

		for (const node of nodes) {
			const source = node.dataset.mermaidSource;
			if (!source) continue;
			node.textContent = source;
			node.removeAttribute('data-processed');
		}

		await mermaid.run({ nodes });
	}

	function scheduleRender() {
		if (renderScheduled) return;
		renderScheduled = true;
		requestAnimationFrame(() => {
			renderScheduled = false;
			renderMermaid().catch((err) => console.warn('[mermaid] render failed', err));
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', scheduleRender, { once: true });
	} else {
		scheduleRender();
	}

	document.addEventListener('astro:page-load', scheduleRender);
	document.addEventListener('astro:after-swap', scheduleRender);

	new MutationObserver(scheduleRender).observe(document.documentElement, {
		attributes: true,
		attributeFilter: ['data-theme'],
	});
</script>
